# 引擎
## 定义
用于存储、处理和保护数据的核心服务
## 作用
* 设计并创建数据库
* 访问并修改数据库中的数据
* 日志管理与性能优化
## 设定引擎方法
* 修改配置文件
* 建表时定义
* 建表后更改
## 常见引擎
* InnoDB
* MyISAM
### InnoDB
InnoDB是一个[事务](#transaction)型存储引擎，有[行锁](#lock)和[外键约束](#foreign_key)
#### 特点
* 支持大数据库
* 建立缓冲池，导致FULLTEXT类型索引不可用
* 不保存行号，导致COUNT全表时，真的在COUNT全表
* 使用行锁，支持高并发，当扫描范围不确定时，会锁整个表
#### 使用环境
* 高并发，更新频繁
* 事务支持
* 灾难回滚
* 外键约束
* 自增主键
#### 聚簇索引
主树使用度数上百的B+树并将整行数据存在叶节点中，而辅助索引中存的是主键值
### MyIASM
MyIASM不支持事务，不支持行锁和外键
#### 特点
MyIASM独立于操作系统，迁移十分方便
* FRM：存储表定义
* MYD：存储数据
* MYI：存储索引
#### 使用环境
* 不支持事务，但可在服务级自定义事务控制
* 查询速度非常快
* 存储行号
* 不能仅凭数据库本身实现损坏恢复
#### 非聚簇索引
主树与辅助索引均只存储实际数据在数据文件中的指针(偏移值)
## ref
[mysql各种引擎对比、实战](https://www.cnblogs.com/sunsky303/p/8274586.html)


# 表
## 表的状态
```
show table status from {table_name}
```



# 其他
## 主键
### 特点
* 主键对用户没有意义
* 主键为单列
* 主键永不更新
* 主键最好自动生成
<h2 id="foreign_key">外键</h2>
字段A在表α中不是主键，但每一个非null取值(允许null的话)在表β中是主键，则称A为α的外键
### 作用
维持表与表之间的关系，进而保持数据的整体一致性和完整性

在MySql下外键的on delete规则有如下
* CASCADE:级联，删除主键表时，也会删除其他与之关联的表
* NO ACTION，RESTRICT:约束/限制，删除表中记录时，检查该记录是否有对应外键，有则不允许删除
* SET NULL:在主键表中删除记录时，将子表中有该外键的外键值设为null
### 创建
```
FOREIGN KEY ({foreign_col}) REFERENCES {table}({primary_col})
```
### ref
[外键及其约束理解](https://www.cnblogs.com/chenxiaohei/p/6909318.html)
<h2 id="lock">锁</h2>
### 定义
锁是一种协调并发的机制
### 种类
* 表锁:加解锁快，并发度低，不会死锁
* 页锁:中等，会死锁
* 行锁:加解锁慢，并发度高，会死锁
### 场景
* InnoDB使用gap锁隔离各类事务(例如已提交读RC，可重复读RR)，维持一个事务中的数据一致性，避免RC加锁的情况下幻读。例如改记录[2,4,6]中的4时，InnoDB会锁上2到6中的所有空间，避免其他线程产生干扰。
* InnoDB大部分时候用行锁，大量数据修改可改用表锁，或者需要遍历表的操作也会产生表锁
### 隔离种类
* 串行化(Serializable)：读写锁
* 重复读(Repeatable Read):读锁限制写锁
* 提交读(Read Committed)
* 未提交读(Read Uncommitted)
### 隔离不当后的结果
* 脏读：事务B修改数据，事务A读，数据B回滚，事务A读到了没有被提交的数据(提交读/重复读/串行化)
* 不可重复读：事务A读一次，事务B修改，事务A又读，数据不匹配(串行化/重复读)
* 幻读：事务A读到M条数据，事务B添加N条数据，事务A又读到M+N条数据(串行化/gap锁)
### 死锁
#### 探测
* 被动：InnoDB为每个事务计时，等待时间过长则认为出现死锁，进行回滚操作
* 主动：waif-for graph：建立一个资源需求有向图，再从图中找环
#### 成因
* 事务A在0时锁上表α，事务B在时刻1锁上表β，事务A在时刻2修改β，事务B在时刻3修改α
* 两个事物在事务内部分别先后修改两行
* 索引上的锁冲突，事务A先锁二级索引再锁聚簇索引，事物B只锁聚簇索引，导致聚簇索引上发生锁冲突
* gap锁
#### 如何避免
* 访问尽量有序
* 大事拆小
* 尽量一句话锁所有需要资源
* 降低隔离界别
* 添加索引(挨个遍历记录容易锁)
### ref
[mysql死锁问题分析](https://www.cnblogs.com/LBSer/p/5183300.html)
[MySQL 加锁处理分析](http://hedengcheng.com/?p=771#_Toc374698322)
[通俗地解释脏读、不可重复读、幻读](https://blog.csdn.net/Somhu/article/details/78775198)
<h2 id="transaction">事务</h2>
### 定义
一个最小工作单元，需要多条语句共同完成，事务之于语句有关，与数据无关
### 要求
事务中的语句必须全成功或全失败(加锁保持一致性)
### 特征
* 原子性
* 一致性
* 隔离性
* 持久性
### 生命周期
* 开始：运行任意一条语句
* 结束：commit/rollback(在commit之前，只操作内存内容，不修改硬盘内容)
### ref
[MySQL——事务(Transaction)详解](https://blog.csdn.net/w_linux/article/details/79666086)

## 驱动表
进行多表查询时
* 未指定条件时，行数少的表
* 指定条件时，满足条件的行数少的表
### LEFT/RIGHT JOIN
本质上是指定了谁作为驱动表
### 提高性能的方法
总使用小表驱动大表
